#!/bin/bash

# Pre-commit hook for PhysioAI
# Runs ktlint format on backend and prettier on frontend

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit formatting...${NC}"

# Get the root directory of the repository
ROOT_DIR="$(git rev-parse --show-toplevel)"

# Check for staged Kotlin files
STAGED_KT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.kts?$' || true)

# Check for staged frontend files
STAGED_FRONTEND_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^frontend/.*\.(ts|tsx|js|jsx|json|css)$' || true)

# Format Backend (ktlint)
if [ -n "$STAGED_KT_FILES" ]; then
    echo -e "${YELLOW}Formatting Kotlin files with ktlint...${NC}"
    cd "$ROOT_DIR/backend"

    if ./mvnw antrun:run@ktlint-format -q; then
        echo -e "${GREEN}✓ Kotlin files formatted${NC}"

        # Re-add the formatted files
        cd "$ROOT_DIR"
        echo "$STAGED_KT_FILES" | xargs git add
    else
        echo -e "${RED}✗ ktlint formatting failed${NC}"
        exit 1
    fi
fi

# Format Frontend (Prettier)
if [ -n "$STAGED_FRONTEND_FILES" ]; then
    echo -e "${YELLOW}Formatting frontend files with Prettier...${NC}"
    cd "$ROOT_DIR/frontend"

    # Get only the file paths relative to frontend directory
    FRONTEND_RELATIVE_FILES=$(echo "$STAGED_FRONTEND_FILES" | sed 's|^frontend/||')

    if echo "$FRONTEND_RELATIVE_FILES" | xargs npx prettier --write; then
        echo -e "${GREEN}✓ Frontend files formatted${NC}"

        # Re-add the formatted files
        cd "$ROOT_DIR"
        echo "$STAGED_FRONTEND_FILES" | xargs git add
    else
        echo -e "${RED}✗ Prettier formatting failed${NC}"
        exit 1
    fi
fi

if [ -z "$STAGED_KT_FILES" ] && [ -z "$STAGED_FRONTEND_FILES" ]; then
    echo -e "${GREEN}No files to format${NC}"
fi

echo -e "${GREEN}✓ Pre-commit formatting complete${NC}"

# Run tests
echo -e "${YELLOW}Running tests...${NC}"
cd "$ROOT_DIR"

if ./scripts/run-tests; then
    echo -e "${GREEN}✓ All tests passed${NC}"
else
    echo -e "${RED}✗ Tests failed - commit aborted${NC}"
    exit 1
fi
